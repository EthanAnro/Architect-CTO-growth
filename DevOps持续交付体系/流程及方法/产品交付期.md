二、产品交付期
=============
- [二、产品交付期](#二、产品交付期)
    - [1. 持续集成（Continuous integration  简称CI）](#1持续集成（-continuous-integration简称-ci）)
      - [1.1 持续集成的步骤](#1-1持续集成的步骤)
      - [1.2 持续集成的实践](#1-2持续集成的实践)
        - [1.2.1 使构建过程脚本化，搭建持续集成框架](#1-2-1使构建过程脚本化，搭建持续集成框架)
        - [1.2.2 向构建中添加已有的自动化验证集合](#1-2-2向构建中添加已有的自动化验证集合)
        - [1.2.3 选择利于持续集成的分支策略](#1-2-3选择利于持续集成的分支策略)
        - [1.2.4 建立六步提交法](#1-2-4建立六步提交法)
    - [2. 持续测试](#2持续测试)
      - [2.1 Brian Marick 测试四象限](#2-1-brian-marick测试四象限)
      - [2.2 测试类型](#2-2测试类型)
        - [2.2.1 单元测试](#2-2-1单元测试)
        - [2.2.2 组件测试](#2-2-2组件测试)
        - [2.2.3 集成测试](#2-2-3集成测试)
        - [2.2.4 验收测试](#2-2-4验收测试)
    - [3. 持续部署（发布）](#3持续部署（发布）)
      - [3.1 高频发布的好处](#3-1高频发布的好处)
      - [3.2 低风险发布策略](#3-2低风险发布策略)
        - [3.2.1 蓝绿部署](#3-2-1蓝绿部署)
        - [3.2.2 滚动部署](#3-2-2滚动部署)
        - [3.2.3 灰度发](#3-2-3灰度发)
    - [4. 软件配置管理](#4软件配置管理)
      - [4.1 核心原则](#4-1核心原则)
      - [4.2 制品库管理](#4-2制品库管理)
        - [4.2.1 临时软件包库](#4-2-1临时软件包库)
        - [4.2.2 正式软件包库](#4-2-2正式软件包库)
        - [4.2.3 外部软件包库](#4-2-3外部软件包库)
      - [4.3 数据版本管理](#4-3数据版本管理)
    - [总：部署流水线](#总：部署流水线)
      - [1. 核心阶段](#1核心阶段)
        - [基础环境准备](#基础环境准备)
        - [1.1 “提交构建”阶段](#1-1“提交构建”阶段)
        - [1.2 “UAT验收测试”阶段](#1-2“-uat验收测试”阶段)
        - [1.3 “部署/发布”阶段](#1-3“部署发布”阶段)
      - [2. 基础支撑服务](#2基础支撑服务)
      - [3. 需遵守的原则](#3需遵守的原则)

在此阶段要完成产品的**开发、测试、验收、发布**，在过程中进行**持续集成、自动化测试、持续部署**等软件工程实践，构建“**部署流水线**”。
![持续交付](https://thumbnail0.baidupcs.com/thumbnail/98d0268bemce909895f83fcd6cadd1ee?fid=1495796980-250528-568928965157401&time=1654524000&rt=sh&sign=FDTAER-DCb740ccc5511e5e8fedcff06b081203-GONTqAfvgrhIx295D4Y0aP7PVVM=&expires=8h&chkv=0&chkbd=0&chkpc=&dp-logid=181026293061824475&dp-callid=0&file_type=0&size=c710_u400&quality=100&vuk=-&ft=video)
### 1. 持续集成（Continuous integration  简称CI）
持续集成是一种软件开发实践，团队成员频繁将他们的工作成果集成在一起；每次代码提交后，自动触发运行一次包含自动化验证集的构建任务，以便能尽早发现集成问题。 
>持续集成是一种质量反馈机制，其目的是尽早发现代码中的质量问题。
#### 1.1 持续集成的步骤
![持续集成的步骤](https://thumbnail0.baidupcs.com/thumbnail/63972b704j7b64b45be952a0b196defd?fid=1495796980-250528-927256674862887&time=1654520400&rt=sh&sign=FDTAER-DCb740ccc5511e5e8fedcff06b081203-f7l8LVWF6bLOhV4ra24kn0Y6OZU%3D&expires=8h&chkv=0&chkbd=0&chkpc=&dp-logid=180252108097271662&dp-callid=0&file_type=0&size=c710_u400&quality=100&vuk=-&ft=video)

（1）开发人员将代码提交到代码仓库。

（2）CI服务器按一定的时间间隔对代码仓库进行轮询，发现有代码变更。

（3）CI服务器自动将最新代码检出到已准备好的CI/构建服务器上。

（4）在CI/构建服务器上运行由持续集成服务器指定的构建脚本或命令，对最新代码进行检查（如编译打包、代码动静态检查、运行单元测试、部署并运行功能测试等）。

（5）运行结束后，将各流程结果反馈给开发团队。

#### 1.2 持续集成的实践
##### 1.2.1 使构建过程脚本化，搭建持续集成框架
选择一款持续集成工具，创建一个构建任务，编写构建脚本，使之自动完成软件项目的编译、构建和打包工作。
##### 1.2.2 向构建中添加已有的自动化验证集合
向构建中加入代码规范扫描，向构建中添加自动化测试用例。
##### 1.2.3 选择利于持续集成的分支策略
常见的分支开发模式有“主干开发，主干发布”，“主干开发，分支发布”，“分支开发，主干发布”。
##### 1.2.4 建立六步提交法
（1）检出最新代码

（2）编写或修改代码

（3）第一次个人构建

（4）检出最新代码进行第二次个人构建

（5）提交代码到团队主干

（6）持续构建

### 2. 持续测试
#### 2.1 Brian Marick 测试四象限
![测试四象限](https://thumbnail0.baidupcs.com/thumbnail/3d800870bo29f4a212dc8b840955c671?fid=1495796980-250528-848655453826995&time=1654520400&rt=sh&sign=FDTAER-DCb740ccc5511e5e8fedcff06b081203-pdh822BvAdJBqZ2KMVL0j1zqXl8%3D&expires=8h&chkv=0&chkbd=0&chkpc=&dp-logid=180350105556553528&dp-callid=0&file_type=0&size=c710_u400&quality=100&vuk=-&ft=video)

>编写自动化测试因为有时间成本，引入自动化测试最好的方式是选择应用程序中那些最常见、最重要且高价值的用例为起点。
>
#### 2.2 测试类型
##### 2.2.1 单元测试
测试单个组件的内部单元（比如方法、类或函数 ）。
##### 2.2.2 组件测试
测试子系统内的组件（模块）。
##### 2.2.3 集成测试
测试支持应用程序运行的一个或多个子系统。
##### 2.2.4 验收测试 
验收测试可以测试系统特性的方方面面，包括其功能、性能、易用性、安全性、可用性等。

### 3. 持续部署（发布）
#### 3.1 高频发布的好处
（1）有更多的机会与真实用户互动，从而快速决定或调整自己产品前进的方向。 

（2）由于每次变更规模较小，软件系统没有剧烈的变化，从而降低部署风险。
 
（3）单次部署成本降低，且趋于恒定。 

（4）出现问题易定位、易修复，且能够快速更正。 
#### 3.2 低风险发布策略
##### 3.2.1 蓝绿部署
蓝绿部署是指准备两套完全一致的运行环境，其中一套环境作为正式生产环境，对外提供软件服务。另一套环境作为新版本的预生产环境，部署软件的新版本，并对其进行验收测试。 
##### 3.2.2 滚动部署
滚动部署是指从服务集群中选择一个或多个服务单元，先执行部分版本更新，进行验收测试。循环往复，直至集群中所有的服务实例都更新到新版本。
##### 3.2.3 灰度发
灰度发布（也叫金丝雀发布）指通过让一小部分用户先行使用新版本，以便提前发现软件存在的问题，待这部分用户没有问题时再逐渐扩展到全量用户。
>建议采用比例“1%——> 10%——>50%——>100%”的逐级增加  

### 4. 软件配置管理
我们需要对整个IT价值路流程中的需求、源代码、软件包、数据文件、脚本、配置文件等进行版本管理和生命周期管理。
#### 4.1 核心原则
- 对能进行版本管理的一切进行版本管理
- 共享唯一受信源
#### 4.2 制品库管理
##### 4.2.1 临时软件包库
临时软件包库用于存储企业内部团队开发的通过部署流水线生成代码的所有软件包，例如每次触发构建后产生的二进制包。该仓库中的二进制包不能被直接部署到生产环境，必须转入正式软件包库才可以。 
##### 4.2.2 正式软件包库
正式软件包库用于存储那些经过部署流水线验证，被确认能够且将要被发布到生产环境（或用户手中）的软件包。 
##### 4.2.3 外部软件包库
外部软件包库是指该软件包的源代码不是由企业自身团队管理和维护，但是企业在研发自己的软件产品过程中所用到的软件制品。这些软件制品由企业从互联网或第三方机构获得，并保存到外部软件包库中。 
![制品库流水线](https://thumbnail0.baidupcs.com/thumbnail/ee673c420i6091410e6e19ddf6f6f702?fid=1495796980-250528-226922582279186&time=1654520400&rt=sh&sign=FDTAER-DCb740ccc5511e5e8fedcff06b081203-vPNET%2FGs8ZWtsOe9g3V%2BtrIecjI%3D&expires=8h&chkv=0&chkbd=0&chkpc=&dp-logid=180460277336204707&dp-callid=0&file_type=0&size=c710_u400&quality=100&vuk=-&ft=video)

#### 4.3 数据版本管理
数据库脚本版本管理（Todo）

### 总：部署流水线
部署流水线是对软件交付过程的一种自动化的运转方式，并提供了可视化呈现形式，展现了从代码提交、构建、部署、测试到发布的整个过程，为团队提供状态可视化和即时反馈。 
>部署流水线的设计受到软件架构、分支策略、团队结构以及产品形态的影响，因此每个产品的部署流水线均有所不同。
>

![部署流水线](https://thumbnail0.baidupcs.com/thumbnail/08b41534cv6489e37e4503e47e5544e7?fid=1495796980-250528-648223227683044&time=1654520400&rt=sh&sign=FDTAER-DCb740ccc5511e5e8fedcff06b081203-BS46t268jUzT2fzUvoXneGck308%3D&expires=8h&chkv=0&chkbd=0&chkpc=&dp-logid=180548519109087995&dp-callid=0&file_type=0&size=c710_u400&quality=100&vuk=-&ft=video)

#### 1. 核心阶段
建成部署流水线首先要做基础环境准备
##### 基础环境准备
运维人员为团队准备部署流水线运行所需要的基础环境，如用于编译打包的构建环境、单元/集成测试用的测试环境、验收测试的UAT（User Acceptance Environment  用户验收测试）环境，部署/发布用的生产环境。 
##### 1.1 “提交构建”阶段
此阶段当代码提交至代码仓库后，构建服务响应进行编译打包、代码静态检查、程序动态检测、自动化单元/集成测试，通过之后将软件包放入制品库。
##### 1.2 “UAT验收测试”阶段
此阶段从制品库中选择软件包部署至UAT环境，进行应用程序的UAT测试（包含功能测试和非功能性测试等）。
>（UAT部署）可由测试工程师手工触发。测试工程师根据具体需求完成情况，选择一个被测版本，向UAT环境部署软件包，进行手工/自动化验收测试。
>
##### 1.3 “部署/发布”阶段
将经过UAT测试的软件包进行生产环境的部署（针对后台或web），用户环境的发布（移动端）。
> 发布策略后续会讲到：如蓝绿部署、灰度发布等

#### 2. 基础支撑服务
-  编译构建管理服务
- 测试管理服务
- 软件部署管理服务
- 基础环境管理服务
![基础支撑服务](https://thumbnail0.baidupcs.com/thumbnail/0bbc6933bl0495144b556497c685914a?fid=1495796980-250528-423985694048294&time=1654524000&rt=sh&sign=FDTAER-DCb740ccc5511e5e8fedcff06b081203-d83uqjJA7Iw32tbxElzUeSlXVnk%3D&expires=8h&chkv=0&chkbd=0&chkpc=&dp-logid=180617232439211191&dp-callid=0&file_type=0&size=c710_u400&quality=100&vuk=-&ft=video)

#### 3. 需遵守的原则
- 任何软件包的取用皆须通过受控源（制品库），而非私有渠道获得。
- 尽可能将所有流程自动化，并持续优化执行时间。
- 每次提交都能够自动触发部署流水线。
- 当出现问题时必须执行立即暂停原则。
